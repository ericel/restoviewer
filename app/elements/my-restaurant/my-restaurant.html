<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<dom-module id="my-restaurant">

  <template>
    <style include="shared-styles">
      :host {
        display: block;
        color: #202020;
        font-family:'Roboto', 'Noto', sans-serif;
      }
      .big-icon paper-icon-button {
          height:60px;
          width: 60px;
      }

    
    </style>
     <div class="layout vertical">
    
      <div class="l-grid">
       <div id="restimg" tabindex="0"></div>
      <div class="innertube">
      
      <h4 tabindex="0"> <span id="restname"></span>'s Restaurant</h4>
      <p tabindex="0">
      <span  id="ratingstars"></span>
      </p>
      <p tabindex="0"><iron-icon prefix icon="maps:place"></iron-icon> <span id="address"></span></p>
      <p tabindex="0"><iron-icon prefix icon="date-range"></iron-icon> Mons - Sats: 9AM ~ 10pm</p>
       
      </div>
    </div>
    <div class="l-grid-1" tabindex="0">
      <h1  class="page-title" tabindex="0">Restaurant Review</h1>
       <div class="unfocused-line style-scope paper-input-container"></div>
       <form is="iron-form" id="reviewForm">
       <!--
       <paper-input name="fullname" id="fullname" label="Full Name" autofocus auto-validate pattern="^[a-zA-Z\s]*$" error-message="Only letters accepted" required></paper-input>
      
       <div class="rstar">
      <b>Rate by Stars</b>
      <label>Click To Rate:</label>
       <div class="unfocused-line style-scope paper-input-container"></div>

       <div class="rat-stars big-icon">
       <span id="star1">
       <paper-icon-button icon="icons:star-border" class="fill_star"></paper-icon-button>
       </span>
       <span id="star2">
       <paper-icon-button icon="icons:star-border" class="fill_star"></paper-icon-button>
       </span>
       <span id="star3">
       <paper-icon-button icon="icons:star-border" class="fill_star"></paper-icon-button>
       </span>
       <span id="star4">
       <paper-icon-button icon="icons:star-border" class="fill_star"></paper-icon-button>
       </span>
       <span id="star5">
       <paper-icon-button icon="icons:star-border" class="fill_star"></paper-icon-button>
       </span>
       <input id="starwars" value="0" type="hidden">
      </div>
      </div>
      <div class="txt-review">
       <div class="unfocused-line style-scope paper-input-container"></div>
      
      <b>Say something about this restaurant:</b>
      <div class="unfocused-line style-scope paper-input-container"></div>
         <paper-textarea label="Add a comment" id="comment" auto-validate error-message="Review comment needed" value="" required></paper-textarea>

         <div class="btn-align">
         <div id="status"></div>
          <div class="margin20"></div>
               <paper-button raised class="custom green" id="idRest" onclick="_reviewSubmit(event)"><paper-spinner id="spinnerreview"></paper-spinner>Post Review</paper-button>
                </div>-->
      </form>
      </div>
    </div>

     <div class="clearfix"></div>
     <div class="reviews">
        <h1> Customer Reviews: </h1>
        <div class="unfocused-line style-scope paper-input-container"></div>

         <div id="reviewsadded"></div>
         <div id="reviews"></div>


  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'my-restaurant',

        properties: {
          routeParams: {
            type: Object,
            observer: '_routeParams'
          }
        },
        ready: function(){
           var reviewForm = this.$.reviewForm;
           var idRest = this.$.idRest;
           var rspinner = this.$.spinnerreview;
              reviewForm.addEventListener('mouseout', function(event) {
              idRest.disabled = !reviewForm.validate();
              rspinner.hidden = true;
            });
          

        },
        _routeParams: function(newValue) {
          /* console.log('route params: ', newValue);
           String.prototype.capitalize = function() {
              return this.charAt(0).toUpperCase() + this.slice(1);
          }*/
         var routeparams = newValue.name;

          var xmlhttp = new XMLHttpRequest();
          var url = "api.json";

          xmlhttp.onreadystatechange = function() {
              if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                  var reviewer = JSON.parse(xmlhttp.responseText);
                   runsearch(reviewer);
                }
              };
             xmlhttp.open("GET", url, true);
             xmlhttp.send();
             function runsearch(array){
              var apijson = array;
              var filtered =  apijson.filter(function(item) {
                return item.rest_id === parseInt(routeparams);
              });

               if(routeparams != ''){
                document.title = filtered[0].rest_name;
               }

              //Get localstorage from useragent
              var localST = '';
              if (typeof(Storage) !== "undefined") {
                  if(localStorage.getItem("restID") === routeparams){
                    if(localStorage.stars === 'One Star'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="1" class="custom-class"></star-rating></div>';
                } else if (localStorage.stars === 'Two Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="2" class="custom-class"></star-rating></div>';
                } else if (localStorage.stars === 'Three Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="3" class="custom-class"></star-rating></div>';
                } else if (localStorage.stars === 'Four Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="4" class="custom-class"></star-rating></div>';
                } else if (localStorage.stars === 'Five Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="5" class="custom-class"></star-rating></div>';
                } 
                    
                       localST = '<paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>'+localStorage.names+'</b> Date: '+localStorage.datest+'<div class=" small-icon"> <iron-icon prefix icon="star"></iron-icon> <b> Rating : </b>'+ratstar+'</div><p><iron-icon prefix icon="communication:textsms"></iron-icon> <b> Review : </b> '+localStorage.comments+' </p></paper-material>';
                    document.querySelector('#reviews').innerHTML = localST;
                  } else {
                    document.querySelector('#reviews').innerHTML = localST;
                  }

              } else {
                  console.log('Sorry! No Web Storage support..');
              }

             if(filtered.length === 0){
               console.log('<paper-material elevation="1" class="no-resto">Oops! No restaurants returned. Change your search settings!.</paper-material>');
             }
             var ratstar = '';
             if(filtered[0].rest_rating === 'One Star'){
                  ratstar ='<star-ratings value="1" count="5"></star-ratings>';
                } else if (filtered[0].rest_rating === 'Two Stars'){
                  ratstar ='<star-ratings value="2" count="5"></star-ratings>';
                } else if (filtered[0].rest_rating === 'Three Stars'){
                  ratstar ='<star-ratings value="3" count="5"></star-ratings>';
                } else if (filtered[0].rest_rating === 'Four Stars'){
                  ratstar ='<star-ratings value="4" count="5"></star-ratings>';
                } else if (filtered[0].rest_rating === 'Five Stars'){
                  ratstar ='<star-ratings value="5" count="5"></star-ratings>';
                } 
              var restphoto = '<iron-image style="width:100%; height:150px;" background-color: lightgray;" preload fade sizing="cover" src="https://restoviewer.firebaseapp.com/images/'+filtered[0].rest_photo+'.jpg" alt="'+filtered[0].rest_name+'" id="'+filtered[0].rest_photo+'"></iron-image>';
              document.querySelector('#ratingstars').innerHTML = ratstar;
              document.querySelector('#address').innerHTML = filtered[0].rest_address;
              document.querySelector('#restname').innerHTML = filtered[0].rest_name;
              document.querySelector('#restimg').innerHTML = restphoto;
              //console.log(filtered[0].rest_name);

             var reviews = '<paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>'+filtered[0].rest_reviewer+'</b> Date: '+filtered[0].rest_review_date+'<div class=" small-icon"> <iron-icon prefix icon="star"></iron-icon> <b> Rating : </b>'+ratstar+'</div><p><iron-icon prefix icon="communication:textsms"></iron-icon> <b> Review : </b> '+filtered[0].rest_reviews+' </p></paper-material>';
              document.querySelector('#reviews').innerHTML = document.querySelector('#reviews').innerHTML + reviews;
              var dirtMock = '<div><paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>Jeremy</b> Date: 07/01/2016<div class=" small-icon"><iron-icon prefix icon="star"></iron-icon> <b> Rating : </b> <star-ratings value="3" count="5"></star-ratings></div></div> <p><iron-icon prefix icon="communication:textsms"></iron-icon> <b> Review : </b> nusquam nominavi periculis, sit elit oportere ea.Cu mei vide viris gloriatur, at populo eripuit sit.</p></paper-material></div><paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>Mark</b> Date: 15/01/2016<div class=" small-icon"> <iron-icon prefix icon="star"></iron-icon> <b> Rating : </b> <star-ratings value="4" count="5"></star-ratings></div><p><iron-icon prefix icon="communication:textsms"></iron-icon> <b> Review : </b> nusquam nominavi periculis, sit elit oportere ea.Cu mei vide viris gloriatur, at populo eripuit sit. </p></paper-material><paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>Eric Oj</b> Date: 30/01/2016<div class=" small-icon"><iron-icon prefix icon="star"></iron-icon> <b> Rating : </b><star-ratings value="3" count="5"></star-ratings></div><p><iron-icon prefix icon="communication:textsms"></iron-icon><b> Review : </b> nusquam nominavi periculis, sit elit oportere ea.Cu mei vide viris gloriatur, at populo eripuit sit. </p></paper-material></div></div></div>'
              document.querySelector('#reviews').innerHTML = document.querySelector('#reviews').innerHTML + dirtMock;
          
           } // end function
           var star1 = document.querySelector('#star1'),
               star2 = document.querySelector('#star2'),
               star3 = document.querySelector('#star3'),
               star4 = document.querySelector('#star4'),
               star5 = document.querySelector('#star5'),
               starwars = document.querySelector('#starwars');
             
          star1.addEventListener('click', function(){
             star1.innerHTML = '<paper-icon-button icon="icons:star" class="fill_star"></paper-icon-button>';
             starwars.value = "One Star";
          });
          
            
          }
      });
    })();
    function _reviewSubmit(event) {
      event.preventDefault();
    var today = new Date();
    var dd = today.getDate();
    var mm = today.getMonth()+1; //January is 0!
    var yyyy = today.getFullYear();

    if(dd<10) {
        dd='0'+dd
    } 

    if(mm<10) {
        mm='0'+mm
    } 
 
    today = dd+'/'+mm+'/'+yyyy;
    var spinnerreview = document.querySelector('#spinnerreview');
    var comment = document.querySelector('#comment'),
        status = document.querySelector('#status'),
        name = document.querySelector('#fullname'),
        reviewForm = document.querySelector('#reviewForm'),
        nameVal = name.value,
        commentVal = comment.value,
        starwarsVal = starwars.value;
  
    if(starwarsVal === 'One Star'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="1" class="custom-class"></star-rating></div>';
                } else if (starwarsVal === 'Two Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="2" class="custom-class"></star-rating></div>';
                } else if (starwarsVal === 'Three Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="3" class="custom-class"></star-rating></div>';
                } else if (starwarsVal === 'Four Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="4" class="custom-class"></star-rating></div>';
                } else if (starwarsVal === 'Five Stars'){
                  ratstar ='<div class="custom-wrapper gold"><star-rating showtotals="true" stars="5" rate="5" class="custom-class"></star-rating></div>';
                } 
      routeparams = document.querySelector('#routeparams').value;
    if (typeof(Storage) !== "undefined") {
      if(localStorage.getItem("restID") !== routeparams){
          localStorage.restID = routeparams;
        
   
          localStorage.names = nameVal;
       
          localStorage.stars = starwarsVal;
        
       
          localStorage.comments = commentVal;
       
 
          localStorage.datest = today;
        
        }
    } else {
        console.log('Sorry! No Web Storage support');
    }
    if(starwarsVal === '0') {
      status.innerHTML = 'Click on Stars to rate';
    } else if(commentVal.length < 5) {
      status.innerHTML = 'Add a comment to review. Atleast 5 characters';
    } else if (name.length < 4){
      status.innerHTML = 'Add your name. Atleast 4 characters';
    } else {
        window.scrollTo(0,0);
              reviewForm.innerHTML = '<div class="success">Thank you! Review successfully posted!</div>';
              app.$.toast.text = 'Review Post Successfully!';
              app.$.toast.show();
              setTimeout(function(){ 
                reviewForm.reset();
              }, 3000);

              var posted = '<paper-material elevation="1" tabindex="0"><iron-icon prefix icon="social:person"></iron-icon> <b>'+nameVal+'</b> Date: '+today+'<div class=" small-icon"> <iron-icon prefix icon="star"></iron-icon> <b> Rating : </b>'+ratstar+'</div><p><iron-icon prefix icon="communication:textsms"></iron-icon> <b> Review : </b> '+commentVal+' </p></paper-material>';
              document.querySelector('#reviewsadded').innerHTML =  posted;
    }
       
    }
  </script>
</dom-module>
